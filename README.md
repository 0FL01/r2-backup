# Скрипт резервного копирования Cloudflare R2

Простой, но мощный Bash-скрипт для создания сжатых резервных копий выбранных директорий и загрузки их в бакет Cloudflare R2. Поддерживает автоматическую ротацию бэкапов.

## Возможности

-   Резервное копирование в любое S3-compatible хранилище (преднастроено для Cloudflare R2).
-   Быстрая и эффективная компрессия с помощью `zstd`.
-   Автоматическая ротация старых бэкапов по сроку хранения.
-   Конфигурация через простой файл `.env`.
-   Детализированное логирование всех операций.
-   Проверка зависимостей, чтобы убедиться в готовности окружения.
-   Проверка целостности после загрузки: совпадение MD5; для multipart загрузок скрипт сравнивает локальный и удаленный размер, чтобы убедиться, что занимаемое пространство совпадает.
-   Надёжные загрузки с повторами и экспоненциальной задержкой.

## Предварительные требования

Перед началом убедитесь, что в системе установлены следующие инструменты:

-   `aws-cli` (рекомендуется v2)
-   `zstd`
-   `tar`
-   `jq`

Установка в Debian-подобных системах (например, Ubuntu):

```bash
sudo apt-get update && sudo apt-get install awscli zstd tar jq -y
```

## Настройка

1.  **Клонировать репозиторий**
    Клонируйте этот репозиторий на сервер.
    ```bash
    git clone https://github.com/0FL01/r2-backup.git
    cd r2_backup
    ```

2.  **Сделать скрипт исполняемым**
    ```bash
    chmod +x r2-backup.sh
    ```

3.  **Создать файл конфигурации**
    Создайте файл `.env` в корне проекта. Можно скопировать готовый пример, если он есть.
    ```bash
    cp env.example .env
    ```
    Затем откройте `.env` и добавьте свою конфигурацию.

## Конфигурация

Отредактируйте `.env` с вашими параметрами.

### Обязательные параметры

-   `R2_ENDPOINT`: полный URL Cloudflare R2 endpoint.
-   `R2_ACCESS_KEY_ID`: ваш R2 Access Key ID.
-   `R2_SECRET_ACCESS_KEY`: ваш R2 Secret Access Key.
-   `R2_BUCKET_NAME`: имя бакета R2, куда будут сохраняться бэкапы.
-   `BACKUP_PATHS`: список абсолютных путей к директориям для бэкапа, через запятую.
    -   **Пример**: `BACKUP_PATHS="/var/www/my-site,/etc/nginx,/home/user/data"`

### Необязательные параметры

-   `BACKUP_NAME`: базовое имя архива в бакете. Timestamp и расширение добавляются автоматически. По умолчанию: текущее имя хоста.
-   `USE_ZSTD`: включить/выключить `zstd`. `true` (по умолчанию) создаёт `.tar.zst` с `zstd`; `false` создаёт обычный `.tar` и не требует `zstd`.
-   `ZSTD_LEVEL`: уровень компрессии `zstd` (1 — самый быстрый, 22 — максимальная компрессия). По умолчанию: `3`.
-   `KEEP_BACKUPS`: сколько последних бэкапов хранить. Всё, что выходит за предел, удаляется. По умолчанию: `7`.
-   `LOG_FILE`: абсолютный путь к лог-файлу. По умолчанию: `/var/log/r2-backup.log`.
-   `TEMP_DIR`: временная директория для сборки архива перед загрузкой. По умолчанию: `/tmp/r2-backup`.
-   `USE_TEMP_DIR`: при `true` (по умолчанию) архив собирается в `TEMP_DIR`; при `false` создаётся прямо в первом пути из `BACKUP_PATHS` (если указан файл, используется его родительская директория).
-   `R2_REGION`: регион бакета. По умолчанию: `auto`.

## Использование

### Ручной запуск бэкапа

Чтобы вручную выполнить полный цикл (создание, загрузка, ротация), запустите:

```bash
./r2-backup.sh
```

### Проверка конфигурации

Чтобы проверить наличие зависимостей и читаемость конфигурации без выполнения бэкапа, используйте флаг `--test`:

```bash
./r2-backup.sh --test
```

### Только ротация бэкапов

Чтобы запустить только ротацию и очистить старые бэкапы, используйте флаг `--rotate-only`:

```bash
./r2-backup.sh --rotate-only
```

### Планирование через Cron (автоматические бэкапы)

Чтобы автоматизировать запуск, добавьте задание в crontab.

1. Скопируйте исполняемые файлы
   ```
   sudo mkdir -p /opt/r2-backup && sudo cp -a r2-backup.sh .env /opt/r2_backup/
   ```


2.  Откройте редактор crontab:
    ```bash
    crontab -e
    ```

3.  Добавьте строку для запуска скрипта ежедневно в 04:20. **Не забудьте указать абсолютный путь к вашему `backup.sh`.**

    ```crontab
    # Run the R2 backup script daily at 4:20 AM
    20 4 * * * /opt/r2-backup/r2-backup.sh > /dev/null 2>&1
    ```

    -   `/opt/r2_backup/r2-backup.sh` — абсолютный путь к скрипту.
    -   `> /dev/null 2>&1` не даёт cron отправлять письма с выводом, так как всё уже пишется в `LOG_FILE`.

## Проверки целостности и повторы

-   Каждый upload считает локальный MD5; для single-part загрузок ETag S3 должен совпадать. Если обнаружен multipart upload, скрипт сравнивает `ContentLength` на удалённой стороне с размером локального архива, чтобы убедиться, что занимаемое место одинаковое.
-   Загрузки повторяются до 3 раз с экспоненциальной задержкой (начиная с 5 секунд) и подробным логированием каждой попытки и ответа AWS CLI.

## Логирование

Все операции скрипта пишутся в файл, указанный в `LOG_FILE` вашего `.env` (по умолчанию `/var/log/r2-backup.log`). Смотрите этот файл для подробностей и устранения неполадок.

```bash
tail -f /var/log/r2-backup.log
```
